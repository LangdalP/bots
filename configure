#!/bin/sh

GCC=`gcc -x c -c -fopenmp /dev/null &>/dev/null  && echo "yes"`
MCC=`mcc -v &> /dev/null && echo "yes"`
ICC=`icc -v &> /dev/null && echo "yes"`
XLC=`xlc -qversion &> /dev/null && echo "yes"`

nc=0

if [ "$GCC" = "yes" ]; then
	let nc=nc+1
	COMPILERS[nc]="gcc"
fi

if [ "$MCC" = "yes" ]; then
	let nc=nc+1
	COMPILERS[nc]="mcc"
fi

if [ "$ICC" = "yes" ]; then
	let nc=nc+1
	COMPILERS[nc]="icc"
fi

if [ "$XLC" = "yes" ]; then
	let nc=nc+1
	COMPILERS[nc]="xlc"
fi

if [ "$nc" -gt "0" ]; then
	echo "The following compilers are recognized: "
	n=1
	for comp in ${COMPILERS[*]}; do
 	 	echo "  $n. $comp"
  		let n=n+1
	done
	echo -n "Choose one to use:"
	read 

	COMPILER=${COMPILERS[$REPLY]}
else
	echo "No suitable compiler was detected"
	echo "An empty make.config will be generated"
fi

if [ "$COMPILER" = "gcc" ]; then
	CC=gcc
	CLINK=$CC
	OMPC="$CC -fopenmp"
	OMPLINK="$CC -fopenmp"

	OPT_FLAGS=-O3
	CC_FLAGS=
	OMPC_FLAGS=
	CLINK_FLAGS=
	OMPLINK_FLAGS=
fi

if [ "$COMPILER" = "icc" ]; then
	CC=icc
	CLINK=$CC
	OMPC="$CC -openmp"
	OMPLINK="$CC -openmp"

	OPT_FLAGS=-O2
	CC_FLAGS=
	OMPC_FLAGS=
	CLINK_FLAGS=
	OMPLINK_FLAGS=
fi


if [ "$COMPILER" = "mcc" ]; then
	CC=mcc
	CLINK=$CC
	OMPC=$CC
	OMPLINK=$CC

	OPT_FLAGS=-O3
	CC_FLAGS=
	OMPC_FLAGS=
	CLINK_FLAGS=
	OMPLINK_FLAGS=
fi

if [ "$COMPILER" = "xlc" ]; then
	CC=xlc
	CLINK=$CC
	OMPC="$CC -qsmp=omp"
	OMPLINK=$OMPC

	OPT_FLAGS=-O3
	CC_FLAGS=
	OMPC_FLAGS=-qthreaded
	CLINK_FLAGS=
	OMPLINK_FLAGS=-qthreaded
fi

cat > config/make.config << EOF
#Automatically generated by configure
#compilers and linkers

OMPC=$OMPC
CC=$CC
OMPLINK=$OMPLINK
CLINK=$CLINK

#compiler and linker flags

OPT_FLAGS=$OPT_FLAGS

CC_FLAGS=$CC_FLAGS
OMPC_FLAGS=$OMPC_FLAGS

CLINK_FLAGS=$CLINK_FLAGS
OMPLINK_FLAGS=$OMPLINK_FLAGS

EOF

echo "make.config generated"
echo "Run make to compile the benchmarks"
echo "Use the scripts in the run directory to execute them"

